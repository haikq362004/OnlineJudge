<form id="createContestForm">
    <input type="text" id="title" placeholder="Title" required />
    <input type="text" id="description" placeholder="Description" required />
    <input type="datetime-local" id="startTime" required />
    <input type="datetime-local" id="endTime" required />

    <div id="problems-container">
        <div class="problem-row">
            <select class="problem-id"></select>
            <input type="number" class="problem-score" placeholder="Score" required />
        </div>
    </div>

    <link rel="stylesheet" href="css/style.css" />

    <button type="button" onclick="addProblem()">➕ Add Problem</button>
    <button type="submit">Create Contest</button>
</form>

<script>
    let allProblems = [];

    async function loadProblemList() {
        try {
            const res = await fetch('http://localhost:5024/api/problems/api/problemsInContest');
            allProblems = await res.json();
            populateAllSelects();
        } catch (error) {
            console.error("Error loading problems:", error);
            alert("Failed to load problems.");
        }
    }

    function populateSelect(select) {
        select.innerHTML = ""; // clear old options
        allProblems.forEach(p => {
            const option = document.createElement("option");
            option.value = p.id;
            option.textContent = p.title;
            select.appendChild(option);
        });
    }

    function populateAllSelects() {
        const selects = document.querySelectorAll(".problem-id");
        selects.forEach(select => populateSelect(select));
    }

    function addProblem() {
        const container = document.getElementById("problems-container");
        const row = document.createElement("div");
        row.className = "problem-row";

        const select = document.createElement("select");
        select.className = "problem-id";
        populateSelect(select);

        const scoreInput = document.createElement("input");
        scoreInput.type = "number";
        scoreInput.className = "problem-score";
        scoreInput.placeholder = "Score";
        scoreInput.required = true;

        row.appendChild(select);
        row.appendChild(scoreInput);
        container.appendChild(row);
    }

    document.getElementById("createContestForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const title = document.getElementById("title").value;
        const description = document.getElementById("description").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;

        const problemRows = document.querySelectorAll(".problem-row");
        const problems = [];

        problemRows.forEach(row => {
            const problemId = row.querySelector(".problem-id").value;
            const score = row.querySelector(".problem-score").value;

            if (problemId && score) {
                problems.push({
                    problemId: parseInt(problemId),
                    score: parseInt(score)
                });
            }
        });

        const data = {
            title,
            description,
            startTime,
            endTime,
            problems
        };

        console.log(data);

        fetch('http://localhost:5024/api/Contest/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(res => {
            if (res.ok) {
                alert("Contest created successfully!");
                location.reload(); // Optional: refresh after success
            } else {
                alert("Error creating contest.");
            }
        });
    });

    // Initial load
    loadProblemList();
</script>